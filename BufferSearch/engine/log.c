#include "log.h"
#include <time.h>
#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdlib.h>

int logging_fd;
int logging_fd_copy;


uint8_t ENABLED     = 0x1;
uint8_t SUCCESS_LOG = 0x2;
int8_t FAILURE_LOG  = -1;

uint8_t flags = 0x0;

void init_loggingfile(){

    if(access("./log.byr", F_OK) == 0){
        logging_fd = open("./log.byr", O_WRONLY, 0666);
    }else{
        logging_fd = open("./log.byr", O_CREAT | O_WRONLY, 0666);
    }

    if(logging_fd < 0){
        perror("Could not open logging file");
        exit(0);
    }
}

void disable_log(){
    flags = flags ^ 0x1;
}

void enable_log(){
    flags = flags ^ 0x1;
}

void enable_color(){
    flags = flags ^ (1 << 1);
}

void disable_color(){
    flags = flags ^ (1 << 1);
}

void enable_console_print(){
    flags = flags ^ (1 << 2);
    logging_fd_copy = logging_fd;
    logging_fd = 1;
}

void disable_console_print(){
    flags = flags ^ (1 << 2);
    logging_fd = logging_fd_copy;
}

uint8_t extract_flag_bit(uint8_t bit_space){
    return flags & (1 << bit_space);
}

void red () {
  printf("\x1B[31m");
}

void yellow() {
  printf("\x1B[33m");
}

void blue(){
    printf("\x1B[34m");
}
void reset () {
  printf("\x1B[0m");
}



int8_t write_log(char* log_info, uint8_t level){

    time_t rawtime;
    struct tm * timeinfo;

    time ( &rawtime );
    timeinfo = localtime ( &rawtime );

    if(extract_flag_bit(0) == 0){
        return SUCCESS_LOG;
    }
    
    char* time_ptr = asctime(timeinfo);
    time_ptr[strlen(time_ptr)-1] = '\0';

    char MESSAGE[512];
    memset(MESSAGE, 0, 512);
    int wc;


    switch(level){
        case WARNING:

            if(extract_flag_bit(2) && extract_flag_bit(1)){
                yellow();
            }

            sprintf(MESSAGE, "%s - [WARNING]: %s\n", time_ptr, log_info);
            if((wc = write(logging_fd, MESSAGE, strlen(MESSAGE))) < 0){
                return FAILURE_LOG;
            }
            reset();
            break;
        case ERROR:
            if(extract_flag_bit(2) && extract_flag_bit(1)){
                red();
            }
            sprintf(MESSAGE, "%s - [ERROR]: %s\n", time_ptr, log_info);
            if((wc = write(logging_fd, MESSAGE, strlen(MESSAGE))) < 0){
                return FAILURE_LOG;
            }
            reset();
            break;
        case INFO:
            if(extract_flag_bit(2) && extract_flag_bit(1)){
                blue();
            }
        
            sprintf(MESSAGE, "%s - [INFO]: %s\n", time_ptr, log_info);
            if((wc = write(logging_fd, MESSAGE, strlen(MESSAGE))) < 0){
                return FAILURE_LOG;
            }
            reset();
            break;
        default:
            if(extract_flag_bit(2) && extract_flag_bit(1)){
                red();
            }
            sprintf(MESSAGE, "%s - [ERROR]: %s\n", time_ptr, "Logging level not defined!");
            if((wc = write(logging_fd, MESSAGE, strlen(MESSAGE))) < 0){
                return FAILURE_LOG;
            }
            reset();
            break;
    }

    return 1;
}