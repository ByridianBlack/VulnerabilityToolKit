#include <stdio.h>
#include <stdlib.h>
#include "rc4.h"
#include <stdint.h>
#include <string.h>



uint8_t* keyscheduler(RC4_CONTEXT* context){

    uint8_t* SBOX = malloc(sizeof(uint8_t) * 256);

    for(int i = 0; i < 256; i++){
        SBOX[i] = i;
    }
    uint32_t j = 0;

    for(uint32_t i = 0; i < 256; i++){
        j = (j + SBOX[i] + context->key[i % context->key_size]) % 256;
        uint8_t temp = SBOX[i];
        SBOX[i] = SBOX[j];
        SBOX[j] = temp;
    }

    return SBOX;

}

// uint8_t* rc4_routine(uint8_t* data, uint32_t data_size, uint8_t* key, uint32_t key_size){
void rc4_routine(RC4_CONTEXT* context){


    uint8_t* SBOX = keyscheduler(context);
    // uint8_t* output = malloc(sizeof(uint8_t) * context->data_size);

    (*context).output = malloc(sizeof(uint8_t) * context->data_size);


    memset((*context).output, 0, context->data_size);
    
    uint32_t i = 0;
    uint32_t j = 0;
    int xored = 0;

    for(int z = 0; z< context->data_size; z++){
        i = (i + 1) % 256;
        j = (j + SBOX[i]) % 256;

        uint8_t temp  = SBOX[i];
        SBOX[i] = SBOX[j];
        SBOX[j] = temp;

        xored = SBOX[(SBOX[i] + SBOX[j]) % 256];

        (*context).output[z] = xored ^ context->data[z]; 
        // output[z] = xored ^ data[z];
    }
    free(SBOX);

}

void clean_context(RC4_CONTEXT* context){
    memset(context->output, 0, context->data_size);
    free(context->output);
}

int main(int argc, char const *argv[])
{
    uint8_t* decrypted_data = (uint8_t *) "this is data\0"; // 12
    uint8_t* key            = (uint8_t *) "key\0"; // 3


    // uint8_t* output = rc4_routine(decrypted_data, 12, key, 3);

    // for(int i = 0; i < 12; i++){
    //     printf("%x ", output[i]);
    // }

    // printf("%c\n", 10);
    
    RC4_CONTEXT context;

    context.data = decrypted_data;
    context.data_size = 12;
    context.key = key;
    context.key_size = 3;
    context.output = NULL;

    rc4_routine(&context);
    for(int i = 0; i < context.data_size; i++){
        printf("%x ", context.output[i]);
    }
    
    clean_context(&context);
    return 0;
}
