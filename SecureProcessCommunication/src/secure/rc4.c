#include <stdio.h>
#include <stdlib.h>
#include "rc4.h"
#include <stdint.h>
#include <string.h>
/*
    for i from 0 to 255
    S[i] := i
endfor
j := 0
for i from 0 to 255
    j := (j + S[i] + key[i mod keylength]) mod 256
    swap values of S[i] and S[j]
endfor
*/

uint8_t* keyscheduler(uint8_t* key, uint32_t key_size){

    uint8_t* SBOX = malloc(sizeof(uint8_t) * 256);

    for(int i = 0; i < 256; i++){
        SBOX[i] = i;
    }
    uint32_t j = 0;

    for(uint32_t i = 0; i < 256; i++){
        j = (j + SBOX[i] + key[i % key_size]) % 256;
        uint8_t temp = SBOX[i];
        SBOX[i] = SBOX[j];
        SBOX[j] = temp;
    }

    return SBOX;

}

uint8_t* rc4_routine(uint8_t* data, uint32_t data_size, uint8_t* key, uint32_t key_size){


    uint8_t* SBOX = keyscheduler(key, key_size);
    uint8_t* output = malloc(sizeof(uint8_t) * data_size);

    memset(output, 0, data_size);
    
    uint32_t i = 0;
    uint32_t j = 0;

    for(int z = 0; z<data_size; z++){
        i = (i + 1) % 256;
        j = (j + SBOX[i]) % 256;

        uint8_t temp  = SBOX[i];
        SBOX[i] = SBOX[j];
        SBOX[j] = temp;

        output[i] = SBOX[SBOX[i] + SBOX[j] % 256];
    }

    return output;

}


/*
    i := 0
j := 0
while GeneratingOutput:
    i := (i + 1) mod 256
    j := (j + S[i]) mod 256
    swap values of S[i] and S[j]
    K := S[(S[i] + S[j]) mod 256]
    output K
endwhile

*/

int main(int argc, char const *argv[])
{
    uint8_t* decrypted_data = (uint8_t *) "this is data\0"; // 12
    uint8_t* key            = (uint8_t *) "key\0"; // 3


    uint8_t* output = rc4_routine(decrypted_data, 12, key, 3);

    for(int i = 0; i < 12; i++){
        printf("%x ", output[i]);
    }
    return 0;
}
